services:
  # ============================================================
  # MESH MODE (default): Convert Gaussian Splat to traditional mesh
  # Use: docker compose run splat-to-mesh
  # ============================================================
  splat-to-mesh:
    build: .
    image: splat-pipeline:latest
    volumes:
      - ./data:/data
    environment:
      # ============================================================
      # MODE SELECTION
      # ============================================================
      
      # MODE: Pipeline mode to run
      # - "mesh": Convert splat to mesh (traditional Unity workflow)
      # - "enhance": Enhance splat quality (for direct splat rendering)
      # - Default: mesh
      - MODE=mesh
      
      # ============================================================
      # REQUIRED - Input/Output Files
      # ============================================================
      
      # INPUT_FILE: The Gaussian Splat PLY file to convert (must exist in ./data folder)
      # Supports standard 3DGS exports from Postshot, Luma, Polycam, etc.
      - INPUT_FILE=model.ply
      
      # OUTPUT_FILE: The output mesh filename (will be created in ./data folder)
      # Supported formats: .obj, .ply, .stl, .off, .gltf
      - OUTPUT_FILE=mesh.obj
      
      # ============================================================
      # STAGE 1: Point Cloud Extraction (splat -> point cloud)
      # ============================================================
      
      # OPACITY_THRESHOLD: Minimum opacity (0.0-1.0) for a Gaussian to be included
      # - Lower values (0.1-0.2): Keep more points, including semi-transparent ones (more detail, more noise)
      # - Higher values (0.5-0.7): Keep only solid/opaque points (cleaner mesh, may lose thin features)
      # - Default: 0.3 (balanced)
      - OPACITY_THRESHOLD=0.3
      
      # MAX_SCALE: Maximum Gaussian scale/size to include (filters out large "blobby" Gaussians)
      # - Unset: No scale filtering (keep all sizes)
      # - Small values (0.01-0.05): Only keep small/sharp Gaussians (removes background blobs)
      # - Useful for cleaning up splats with large floaters or sky artifacts
      # - Default: unset (no filtering)
      # - MAX_SCALE=0.05
      
      # ============================================================
      # STAGE 2: Mesh Generation (point cloud -> mesh)
      # ============================================================
      
      # RECONSTRUCTION_METHOD: Surface reconstruction algorithm to use
      # - "bpa": Ball Pivoting Algorithm only (flat surfaces, may have holes)
      # - "poisson": Poisson reconstruction only (watertight, but can be "bubbly")
      # - "hybrid": BPA for main surfaces + Poisson to fill holes (best of both)
      # - Default: hybrid
      - RECONSTRUCTION_METHOD=hybrid
      
      # POISSON_DEPTH: Octree depth for Poisson reconstruction (used in "poisson" and "hybrid" modes)
      # - Lower values (6-7): Faster, smoother, less detail
      # - Higher values (9-11): Slower, more detail preserved
      # - Default: 8 (balanced)
      # - POISSON_DEPTH=8
      
      # HOLE_FILL_DISTANCE: Distance factor for hybrid hole filling (only used in "hybrid" mode)
      # - Controls how far from hole boundaries to look for Poisson fill triangles
      # - Lower values (1.5-2.0): Conservative filling, fewer Poisson triangles
      # - Higher values (4.0-6.0): Aggressive filling, more coverage but may add "bubbly" areas
      # - Default: 3.0
      # - HOLE_FILL_DISTANCE=3.0
      
      # VOXEL_SIZE: Voxel size for point cloud downsampling before meshing
      # - Unset: Auto-calculate based on point cloud density (recommended)
      # - 0: Disable downsampling entirely (use all points - slower, higher detail)
      # - Positive value (e.g., 0.005): Force specific voxel size (larger = fewer points = faster)
      # - Default: auto-calculated
      # - VOXEL_SIZE=0
      
      # TARGET_TRIANGLES: Simplify final mesh to this triangle count
      # - Unset: No simplification (keep all triangles from reconstruction)
      # - Low values (10000-50000): Lightweight mesh for mobile/web
      # - High values (100000+): Detailed mesh for desktop/film
      # - Default: unset (no simplification)
      # - TARGET_TRIANGLES=50000
      
      # OUTLIER_STD_RATIO: Statistical outlier removal sensitivity (std deviation multiplier)
      # - Lower values (1.0-1.5): Aggressive removal (removes more points as outliers)
      # - Higher values (2.5-4.0): Permissive (keeps more points, including potential noise)
      # - Default: 2.0 (balanced)
      - OUTLIER_STD_RATIO=2.0
      
      # THIN_GEOMETRY: Enable thin geometry mode for Ball Pivoting Algorithm
      # - true: Use smaller ball radii to capture thin features (fences, wires, leaves)
      # - false: Standard radii only (faster, but may miss thin structures)
      # - Default: true
      - THIN_GEOMETRY=true
      
      # ============================================================
      # STAGE 3: Mesh Post-Processing
      # ============================================================
      
      # FLIP_NORMALS: Reverse the direction of all mesh normals
      # - true: Flip normals (use if mesh appears inside-out in your viewer)
      # - false: Keep original normal direction
      # - Default: false
      - FLIP_NORMALS=false
      
      # DOUBLE_SIDED: Duplicate all triangles with reversed winding to make mesh visible from both sides
      # - true: Double triangle count, visible from any angle (useful for thin surfaces like leaves)
      # - false: Single-sided mesh (standard, smaller file size)
      # - Default: false
      - DOUBLE_SIDED=false
      
      # SMOOTH_FINAL: Apply Taubin smoothing to reduce mesh roughness
      # - true: Smooth the mesh (reduces sharp edges, can lose detail)
      # - false: Keep raw mesh from BPA reconstruction
      # - Default: false
      - SMOOTH_FINAL=false
      
      # SMOOTH_ITERATIONS: Number of Taubin smoothing passes (only used if SMOOTH_FINAL=true)
      # - Lower values (1-3): Light smoothing, preserves detail
      # - Higher values (10-20): Heavy smoothing, very soft appearance
      # - Default: 5
      # - SMOOTH_ITERATIONS=5
      
      # ============================================================
      # Output Options
      # ============================================================
      
      # KEEP_INTERMEDIATE: Keep the intermediate point cloud PLY file after meshing
      # - true: Save {input}_pointcloud.ply alongside the mesh (useful for debugging)
      # - false: Delete intermediate file after mesh is generated
      # - Default: false
      - KEEP_INTERMEDIATE=false
      
      # VERBOSE: Print detailed progress and statistics during processing
      # - true: Show all processing steps, timings, and statistics
      # - false: Minimal output (errors only)
      # - Default: true
      - VERBOSE=true

  # ============================================================
  # ENHANCE MODE: Improve Gaussian Splat quality for direct rendering
  # Use: docker compose run splat-enhance
  # For use with UnityGaussianSplatting: https://github.com/aras-p/UnityGaussianSplatting
  # ============================================================
  splat-enhance:
    build: .
    image: splat-pipeline:latest
    volumes:
      - ./data:/data
    environment:
      # MODE must be set to "enhance" for splat enhancement pipeline
      - MODE=enhance
      
      # ============================================================
      # REQUIRED - Input/Output Files
      # ============================================================
      
      # INPUT_FILE: The Gaussian Splat PLY file to enhance (must exist in ./data folder)
      - INPUT_FILE=airplane.ply
      
      # OUTPUT_FILE: The enhanced Gaussian Splat PLY filename
      - OUTPUT_FILE=enhanced_airplane.ply
      
      # ============================================================
      # Enhancement Operations
      # ============================================================
      
      # REMOVE_FLOATERS: Remove outlier Gaussians (position/opacity/scale outliers)
      # - true: Remove Gaussians that are likely artifacts
      # - false: Keep all Gaussians
      # - Default: true
      - REMOVE_FLOATERS=true
      
      # DENSIFY_SPARSE: Add new Gaussians in sparse/under-represented regions
      # - true: Detect sparse areas and fill with interpolated Gaussians
      # - false: Don't add new Gaussians
      # - Default: true
      - DENSIFY_SPARSE=true
      
      # SPLIT_LARGE: Split large Gaussians into smaller ones
      # - true: Break up blobby Gaussians for better coverage
      # - false: Keep original Gaussian sizes
      # - Default: true
      - SPLIT_LARGE=true
      
      # ============================================================
      # Enhancement Parameters
      # ============================================================
      
      # GRID_RESOLUTION: Resolution of the 3D grid for sparse region detection
      # - Lower values (20-30): Coarse detection, fills large holes
      # - Higher values (80-100): Fine detection, fills small gaps
      # - Default: 50
      - GRID_RESOLUTION=50
      
      # DENSITY_THRESHOLD: Percentile below which a cell is considered "sparse"
      # - Lower values (5-10): Conservative, only fills very sparse areas
      # - Higher values (15-25): Aggressive, fills more areas
      # - Default: 10
      - DENSITY_THRESHOLD=10
      
      # ============================================================
      # Floater Removal Parameters (used when REMOVE_FLOATERS=true)
      # ============================================================
      
      # FLOATER_STD_THRESHOLD: Remove Gaussians beyond this many standard deviations from centroid
      # - Lower values (1.5-2.0): Aggressive removal, removes more outliers
      # - Higher values (4.0-5.0): Permissive, keeps more edge Gaussians
      # - Default: 3.0
      - FLOATER_STD_THRESHOLD=3.0
      
      # FLOATER_MIN_OPACITY: Remove Gaussians with opacity below this threshold (0.0-1.0)
      # - Lower values (0.01-0.03): Keep semi-transparent Gaussians
      # - Higher values (0.1-0.2): Only keep solid/opaque Gaussians
      # - Default: 0.05
      - FLOATER_MIN_OPACITY=0.05
      
      # ============================================================
      # Aggressive Floater Removal (for messy scans with lots of artifacts)
      # These filters aggressively remove isolated points, small clusters, and specks
      # ============================================================
      
      # SOR_FILTER: Enable Statistical Outlier Removal
      # - true: Remove points with unusually large average neighbor distance
      # - false: Skip SOR filtering
      # - Default: false (enable for aggressive cleanup)
      - SOR_FILTER=false
      
      # SOR_K_NEIGHBORS: Number of neighbors to consider for SOR
      # - Lower values (10-15): Faster, less context
      # - Higher values (25-40): More thorough, slower
      # - Default: 20
      - SOR_K_NEIGHBORS=20
      
      # SOR_STD_RATIO: Std ratio threshold for SOR (lower = more aggressive)
      # - Lower values (1.0-1.5): Aggressive, removes more points
      # - Higher values (2.5-4.0): Permissive, keeps more points
      # - Default: 2.0
      - SOR_STD_RATIO=2.0
      
      # CLUSTER_FILTER: Enable DBSCAN cluster-based filtering
      # - true: Find main cluster(s) and remove small isolated groups
      # - false: Skip cluster filtering
      # - Default: false (enable to remove isolated clusters)
      - CLUSTER_FILTER=false
      
      # CLUSTER_EPS_PERCENTILE: DBSCAN epsilon as percentile of nearest neighbor distances
      # - Lower values (2-5): Tighter clusters, may split legitimate geometry
      # - Higher values (8-15): Looser clusters, may merge artifacts with main geometry
      # - Default: 5
      - CLUSTER_EPS_PERCENTILE=5
      
      # CLUSTER_MIN_SAMPLES: Minimum points for a DBSCAN core point
      # - Lower values (5-8): More lenient clustering
      # - Higher values (15-25): Stricter, requires denser regions
      # - Default: 10
      - CLUSTER_MIN_SAMPLES=10
      
      # CLUSTER_MIN_RATIO: Minimum cluster size as ratio of total points to keep
      # - Lower values (0.005-0.01): Keep smaller clusters
      # - Higher values (0.02-0.05): Only keep large clusters
      # - Default: 0.01 (1%)
      - CLUSTER_MIN_RATIO=0.01
      
      # ISOLATION_FILTER: Enable isolated Gaussian removal
      # - true: Remove Gaussians with too few neighbors in local area
      # - false: Skip isolation filtering
      # - Default: false (enable to remove specks)
      - ISOLATION_FILTER=false
      
      # ISOLATION_RADIUS_PERCENTILE: Search radius as percentile of all distances
      # - Lower values (5-10): Smaller search radius, removes more
      # - Higher values (15-25): Larger search radius, keeps more
      # - Default: 10
      - ISOLATION_RADIUS_PERCENTILE=10
      
      # ISOLATION_MIN_NEIGHBORS: Minimum neighbors required within radius
      # - Lower values (1-2): Very lenient, keeps most points
      # - Higher values (5-10): Strict, removes sparse areas
      # - Default: 3
      - ISOLATION_MIN_NEIGHBORS=3
      
      # ============================================================
      # Densification Parameters (used when DENSIFY_SPARSE=true)
      # ============================================================
      
      # DENSIFY_K_NEIGHBORS: Number of nearest neighbors to interpolate from when filling sparse regions
      # - Lower values (3-4): Less averaging, maintains sharp local features
      # - Higher values (8-10): More averaging, smoother fills
      # - Default: 5
      - DENSIFY_K_NEIGHBORS=5
      
      # DENSIFY_JITTER: Random offset factor for new Gaussians (relative to local scale)
      # - 0: No randomness, Gaussians placed exactly at interpolated positions
      # - Lower values (0.01-0.02): Slight variation for natural appearance
      # - Higher values (0.05-0.1): More spread out fills
      # - Default: 0.02
      - DENSIFY_JITTER=0.02
      
      # ============================================================
      # Split Parameters (used when SPLIT_LARGE=true)
      # ============================================================
      
      # SPLIT_THRESHOLD_PERCENTILE: Split Gaussians above this percentile in scale
      # - Lower values (85-90): Split more Gaussians, finer detail
      # - Higher values (97-99): Only split the very largest blobs
      # - Default: 95
      - SPLIT_THRESHOLD_PERCENTILE=95
      
      # SPLIT_MAX_NEW: Maximum number of new Gaussians to create from splitting
      # - Lower values (5000-10000): Limit growth for memory/performance
      # - Higher values (50000+): Allow extensive splitting
      # - Default: 10000
      - SPLIT_MAX_NEW=10000
      
      # ============================================================
      # Plane Detection & Flattening (for walls, floors, ceilings)
      # Useful for indoor scenes with reflections that cause depth spread
      # ============================================================
      
      # FLATTEN_PLANES: Enable RANSAC plane detection and flattening
      # - true: Detect dominant planes and project nearby Gaussians onto them
      # - false: Skip plane detection
      # - Default: false
      - FLATTEN_PLANES=false
      
      # PLANE_MAX: Maximum number of planes to detect
      # - Lower values (5-8): Detect only the most dominant planes
      # - Higher values (15-25): Detect more surfaces in complex rooms
      # - Default: 10
      - PLANE_MAX=15
      
      # PLANE_DISTANCE: Distance threshold for RANSAC plane inliers
      # - Lower values (0.01-0.03): Strict, only very close Gaussians assigned to plane
      # - Higher values (0.08-0.15): Permissive, more Gaussians flattened
      # - Default: 0.05
      - PLANE_DISTANCE=0.05
      
      # PLANE_MIN_RATIO: Minimum ratio of Gaussians to form a valid plane
      # - Lower values (0.02-0.03): Detect smaller planes
      # - Higher values (0.1-0.2): Only detect major surfaces
      # - Default: 0.05
      - PLANE_MIN_RATIO=0.05
      
      # PLANE_FLATTEN_STRENGTH: How strongly to project Gaussians onto detected planes (0.0-1.0)
      # - Lower values (0.3-0.5): Gentle flattening, preserves some depth variation
      # - Higher values (0.9-1.0): Full projection onto plane
      # - Default: 0.8
      - PLANE_FLATTEN_STRENGTH=0.8
      
      # ============================================================
      # Depth Consistency Filter (removes/fixes reflection artifacts)
      # Identifies Gaussians at incorrect depths compared to neighbors
      # ============================================================
      
      # DEPTH_FILTER: Enable local depth consistency filtering
      # - true: Find and fix depth outliers (e.g., from reflections)
      # - false: Skip depth filtering
      # - Default: false
      - DEPTH_FILTER=false
      
      # DEPTH_NEIGHBORS: Number of neighbors to analyze for depth consistency
      # - Lower values (10-15): Faster, but may miss some outliers
      # - Higher values (25-40): More thorough analysis
      # - Default: 20
      - DEPTH_NEIGHBORS=20
      
      # DEPTH_STD_THRESHOLD: Standard deviations from local surface to be flagged as outlier
      # - Lower values (1.0-1.5): Aggressive, flags more as outliers
      # - Higher values (2.5-4.0): Conservative, only extreme outliers
      # - Default: 2.0
      - DEPTH_STD_THRESHOLD=2.0
      
      # DEPTH_REMOVE_OUTLIERS: Whether to remove depth outliers or project them to surface
      # - true: Remove outlier Gaussians entirely
      # - false: Project outliers to the local surface (preserves color/detail)
      # - Default: false (project instead of remove)
      - DEPTH_REMOVE_OUTLIERS=false
      
      # ============================================================
      # Surface Thickness Compression
      # Compresses regions where Gaussians are spread too thick along normals
      # ============================================================
      
      # COMPRESS_THICKNESS: Enable surface thickness compression
      # - true: Compress overly thick surface regions
      # - false: Skip thickness compression
      # - Default: false
      - COMPRESS_THICKNESS=false
      
      # THICKNESS_NEIGHBORS: Number of neighbors for thickness analysis
      # - Lower values (8-12): Faster, local analysis
      # - Higher values (20-30): More context for thickness measurement
      # - Default: 15
      - THICKNESS_NEIGHBORS=15
      
      # THICKNESS_MAX_FACTOR: Compress if thickness exceeds this factor of median scale
      # - Lower values (1.5-2.0): Aggressive compression
      # - Higher values (4.0-6.0): Only compress very thick regions
      # - Default: 3.0
      - THICKNESS_MAX_FACTOR=3.0
      
      # THICKNESS_STRENGTH: How much to compress thick regions (0.0-1.0)
      # - Lower values (0.3-0.5): Gentle compression
      # - Higher values (0.8-1.0): Strong compression toward median
      # - Default: 0.7
      - THICKNESS_STRENGTH=0.7
      
      # VERBOSE: Print detailed progress
      - VERBOSE=true
